<!DOCTYPE html>
<html lang="en">
<head>
    <!-- hexo-inject:begin --><!-- hexo-inject:end --><meta charset="UTF-8">
<meta name="viewport"
      content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
<meta http-equiv="X-UA-Compatible" content="ie=edge">

    <meta name="description" content="其实不过是杂记">



<title>Nginx SSL证书配置 | 小记</title>



    <link rel="icon" href="/favicon.ico">




    <!-- stylesheets list from _config.yml -->
    
    <link rel="stylesheet" href="/css/style.css">
    



    <!-- scripts list from _config.yml -->
    
    <script src="/js/script.js"></script>
    
    <script src="/js/tocbot.min.js"></script><!-- hexo-inject:begin --><!-- hexo-inject:end -->
    



    
    
        
    


</head>
<body class="dark-theme">
    <!-- hexo-inject:begin --><!-- hexo-inject:end --><div class="wrapper">
        <header>
    <nav class="navbar">
        <div class="container">
            <div class="navbar-header header-logo"><a href="/">小记</a></div>
            <div class="menu navbar-right">
                
                    <a class="menu-item" href="/archives">Posts</a>
                
                    <a class="menu-item" href="/about">About</a>
                
                <input hidden id="switch_default" type="checkbox" class="switch_default">
                <label style="display:none" for="switch_default" class="toggleBtn"></label>
            </div>

        </div>
    </nav>

    
    <nav class="navbar-mobile" id="nav-mobile">
        <div class="container">
            <div class="navbar-header">
                <div>
                    <a href="/">小记</a><a id="mobile-toggle-theme">·&nbsp;Dark</a>
                </div>
                <div class="menu-toggle" onclick="mobileBtn()">&#9776; Menu</div>
            </div>
            <div class="menu" id="mobile-menu">
                
                    <a class="menu-item" href="/archives">Posts</a>
                
                    <a class="menu-item" href="/about">About</a>
                
            </div>
        </div>
    </nav>

</header>
<script>
    var mobileBtn = function f() {
        var toggleMenu = document.getElementsByClassName("menu-toggle")[0];
        var mobileMenu = document.getElementById("mobile-menu");
        if(toggleMenu.classList.contains("active")){
           toggleMenu.classList.remove("active")
            mobileMenu.classList.remove("active")
        }else{
            toggleMenu.classList.add("active")
            mobileMenu.classList.add("active")
        }
    }
</script>
        <div class="main">
            <div class="container">
    
    
        <div class="post-toc">
    <div class="tocbot-list">
    </div>
    <div class="tocbot-list-menu">
        <a class="tocbot-toc-expand" onclick="expand_toc()">Expand all</a>
        <a onclick="go_top()">Back to top</a>
        <a onclick="go_bottom()">Go to bottom</a>
    </div>
</div>

<script>
    document.ready(
        function () {
            tocbot.init({
                tocSelector: '.tocbot-list',
                contentSelector: '.post-content',
                headingSelector: 'h1, h2, h3, h4, h5',
                collapseDepth: 1,
                orderedList: false,
                scrollSmooth: true,
            })
        }
    )

    function expand_toc() {
        var b = document.querySelector(".tocbot-toc-expand");
        tocbot.init({
            tocSelector: '.tocbot-list',
            contentSelector: '.post-content',
            headingSelector: 'h1, h2, h3, h4, h5',
            collapseDepth: 6,
            orderedList: false,
            scrollSmooth: true,
        });
        b.setAttribute("onclick", "collapse_toc()");
        b.innerHTML = "Collapse all"
    }

    function collapse_toc() {
        var b = document.querySelector(".tocbot-toc-expand");
        tocbot.init({
            tocSelector: '.tocbot-list',
            contentSelector: '.post-content',
            headingSelector: 'h1, h2, h3, h4, h5',
            collapseDepth: 1,
            orderedList: false,
            scrollSmooth: true,
        });
        b.setAttribute("onclick", "expand_toc()");
        b.innerHTML = "Expand all"
    }

    function go_top() {
        window.scrollTo(0, 0);
    }

    function go_bottom() {
        window.scrollTo(0, document.body.scrollHeight);
    }

</script>
    

    
    <article class="post-wrap">
        <header class="post-header">
            <h1 class="post-title">Nginx SSL证书配置</h1>
            
                <div class="post-meta">
                    
                        Author: <a itemprop="author" rel="author" href="/">Arthur Lu</a>
                    

                    
                        <span class="post-time">
                        Date: <a href="#">March 30, 2020&nbsp;&nbsp;21:54:47</a>
                        </span>
                    
                    
                </div>
            
        </header>

        <div class="post-content">
            <p>SSL 原理这里就直接省略了，仅记录证书相关配置实践。</p>
<h2 id="一、证书及相关文件"><a href="#一、证书及相关文件" class="headerlink" title="一、证书及相关文件"></a>一、证书及相关文件</h2><p>初次接触 SSL 会被其繁多的后缀和名词所困惑，只要理解 SSL 原理，这些文件其实是很容理解的：</p>
<ul>
<li><code>*.key</code>，这是 SSL 所需要的私钥文件。</li>
<li><code>*.csr</code>，证书签名请求文件，生成前需要先指定私钥，openssl 会自动生成公钥，并要求生成这填入证书主体信息。本质上就是待签名的证书。</li>
<li><code>*.crt</code>，这是 SSL 中的证书文件，记录了证书主体、颁发者（CA）、CA 签名算法、CA 私钥的签名等。将 CSR 交给 CA 进行签名得到 CRT文件。<ul>
<li>CRT 文件支持 Base64 格式和 二进制格式</li>
<li>如果一个文件后缀是 <code>*.crt</code> 是无法得知到底是哪种格式。个人感觉 Base64 格式（PEM）较为多见。</li>
</ul>
</li>
<li><code>*.pem</code>，这是 SSL 证书文件，且明确格式为 Base64。</li>
<li><code>*.der/*.cer</code>，这是 SSL 证书文件，且明确格式为二进制格式。</li>
<li><code>*.pfx</code>，同时包含了公钥和私钥的证书文件，通常在双向认证中会涉及。通常有密码保护。</li>
</ul>
<h2 id="二、自签证书"><a href="#二、自签证书" class="headerlink" title="二、自签证书"></a>二、自签证书</h2><p>可以借助 openssl 工具分别生成服务器和客户端的自签证书。</p>
<h3 id="2-1-生成服务器自签证书"><a href="#2-1-生成服务器自签证书" class="headerlink" title="2.1 生成服务器自签证书"></a>2.1 生成服务器自签证书</h3><p>服务器自签证书用于最常见的 SSL 场景，由客户端校验服务器证书，判断是否安全。<br><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 生成私有 CA</span></span><br><span class="line">$ openssl genrsa -out pri_ca.key 2048</span><br><span class="line">$ openssl req -new -x509 -days 3650 -key pri_ca.key -out pri_ca.crt -subj <span class="string">"/C=CN/ST=GuangDong/L=ShenZhen/O=Hello/OU=World/CN=test_ca"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 生成私钥文件（带密码）</span></span><br><span class="line">$ openssl genrsa -des3 -out server.key 2048</span><br><span class="line"><span class="comment"># 生成 CA 签名请求（本质上就是未带 CA 签名的证书）, 需要确保其中的CN（common name）填写为正确的域名</span></span><br><span class="line">$ openssl req -new -key server.key -out server.csr</span><br><span class="line"><span class="comment"># 用私有 CA 给 CSR 进行签名, 生成 CRT 证书（PEM格式）</span></span><br><span class="line">$ openssl x509 -req -days 365 -<span class="keyword">in</span> server.csr -CA pri_ca.crt -CAkey pri_ca.key -set_serial 01 -out server.crt</span><br><span class="line"><span class="comment"># 给私钥文件去出密码（如果没有去除密码，每次加载ngx配置都需要输入密码）</span></span><br><span class="line">$ mv server.key server.key.bak</span><br><span class="line">$ openssl rsa -<span class="keyword">in</span> ./server.key.bak -out server.key</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看证书信息</span></span><br><span class="line">openssl x509 -noout -text -<span class="keyword">in</span> server.crt</span><br></pre></td></tr></table></figure></p>
<h3 id="2-2-生成客户端证书"><a href="#2-2-生成客户端证书" class="headerlink" title="2.2 生成客户端证书"></a>2.2 生成客户端证书</h3><p>客户端证书和服务器证书是完全一样的，只是配置的位置不同。客户端证书多用于双向认证的场景。<br><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 生成私钥文件（带密码）</span></span><br><span class="line">$ openssl genrsa -des3 -out client.key 2048</span><br><span class="line"><span class="comment"># 生成 CA 签名请求（本质上就是未带 CA 签名的证书）, 需要确保其中的CN（common name）填写为正确的域名</span></span><br><span class="line">$ openssl req -new -key client.key -out client.csr</span><br><span class="line"><span class="comment"># 用私有 CA 给 CSR 进行签名, 生成 CRT 证书（PEM格式）</span></span><br><span class="line">$ openssl x509 -req -days 365 -<span class="keyword">in</span> client.csr -CA pri_ca.crt -CAkey pri_ca.key -set_serial 01 -out client.crt</span><br><span class="line"></span><br><span class="line"><span class="comment"># 导出可以安装到浏览器的 pfx 证书</span></span><br><span class="line">openssl pkcs12 -<span class="built_in">export</span> -out client.pfx -inkey client.key -<span class="keyword">in</span> client.crt -certfile client.crt</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看证书信息</span></span><br><span class="line">openssl x509 -noout -text -<span class="keyword">in</span> client.crt</span><br></pre></td></tr></table></figure></p>
<p>客户端需要 pfx 证书，并在导入浏览器的时候输入密码，用以解开 pfx。</p>
<h2 id="三、证书配置"><a href="#三、证书配置" class="headerlink" title="三、证书配置"></a>三、证书配置</h2><h3 id="3-1-单向认证"><a href="#3-1-单向认证" class="headerlink" title="3.1 单向认证"></a>3.1 单向认证</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">    server_name                     dev-ssl.rail.com.cn;</span><br><span class="line">    listen                          80;</span><br><span class="line">    listen                          443 ssl;</span><br><span class="line"></span><br><span class="line">    #------------------------------------------------------------------------------------</span><br><span class="line">    ssl_certificate                 /data/rail/entry/nginx/conf/ssl/test_ca/server.crt;</span><br><span class="line">    ssl_certificate_key             /data/rail/entry/nginx/conf/ssl/test_ca/server.key;</span><br><span class="line">    ssl_session_timeout             5m;</span><br><span class="line">    ssl_protocols                   TLSv1 TLSv1.1 TLSv1.2;</span><br><span class="line">    ssl_ciphers                     HIGH:!RC4:!MD5:!aNULL:!eNULL:!NULL:!DH:!EDH:!EXP:+MEDIUM;</span><br><span class="line">    ssl_prefer_server_ciphers       on;</span><br><span class="line"></span><br><span class="line">    location / &#123;</span><br><span class="line">        return 200 &quot;hello world&quot;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>如果用了自签证书，还需要进行浏览器对私有 CA 证书的受信配置。<br>需要注意的是，chrome 对证书的认证较为严格，即便是将自签证书的 CA 添加为受信的，也可能会出现 <code>NET::ERR_CERT_COMMON_NAME_INVALID</code> 的异常</p>
<h3 id="3-2-双向认证"><a href="#3-2-双向认证" class="headerlink" title="3.2 双向认证"></a>3.2 双向认证</h3><p>双向认证主要是打开客户端认证，并指定给客户端签发证书的 <code>CA 证书</code>。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">    server_name                     dev-ssl.rail.com.cn;</span><br><span class="line">    listen                          80;</span><br><span class="line">    listen                          443 ssl;</span><br><span class="line"></span><br><span class="line">    #------------------------------------------------------------------------------------</span><br><span class="line">    ssl_certificate                 /data/rail/entry/nginx/conf/ssl/test_ca/server.crt;</span><br><span class="line">    ssl_certificate_key             /data/rail/entry/nginx/conf/ssl/test_ca/server.key;</span><br><span class="line">    ssl_session_timeout             5m;</span><br><span class="line">    ssl_protocols                   TLSv1 TLSv1.1 TLSv1.2;</span><br><span class="line">    ssl_ciphers                     HIGH:!RC4:!MD5:!aNULL:!eNULL:!NULL:!DH:!EDH:!EXP:+MEDIUM;</span><br><span class="line">    ssl_prefer_server_ciphers       on;</span><br><span class="line"></span><br><span class="line">    ssl_client_certificate          /data/rail/entry/nginx/conf/ssl/test_ca/test_ca.crt;</span><br><span class="line">    ssl_verify_client on;</span><br><span class="line"></span><br><span class="line">    location / &#123;</span><br><span class="line">        return 200 &quot;hello world&quot;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>ssl_client_certificate, 声明一个受信的 CA 证书，该证书用于校验客户端证书。</li>
<li>ssl_verify_client, 对客户端进行验证的模式：<ul>
<li>off, 默认值，不进行校验。</li>
<li>on, 对客户端进行校验。</li>
<li>optional, 客户端提供了证书就校验，没提供就不校验。</li>
<li>optional_no_ca, 要求客户端提供证书，但是不强求客户端证书被受信 CA 签名。</li>
</ul>
</li>
</ul>
<p><strong>注意</strong> <code>ssl_client_certificate</code> 一定是配置给客户端签发的 CA 证书，而不是客户端的证书，因为校验某个证书是否有效，是通过 CA 证书去校验的，这和在浏览器配置给服务器颁发证书的 CA 证书同理。</p>
<h3 id="3-3-测试请求"><a href="#3-3-测试请求" class="headerlink" title="3.3 测试请求"></a>3.3 测试请求</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 单向认证, 需要通过 --cacert 指定受信 CA 证书，该 CA 证书用于校验服务器证书。</span></span><br><span class="line">curl --resolve <span class="string">'dev-ssl.rail.com.cn:443:100.109.182.175'</span> <span class="string">"https://dev-ssl.rail.com.cn/test"</span> --cacert ./test_ca.crt</span><br><span class="line"></span><br><span class="line"><span class="comment"># 双向认证，需要指定客户端私钥和客户端证书（对于浏览器的场景，通过 pfx 文件已经同时将两者告诉给了浏览器）</span></span><br><span class="line">curl --resolve <span class="string">'dev-ssl.rail.com.cn:443:100.109.182.175'</span> <span class="string">"https://dev-ssl.rail.com.cn/test"</span> --cacert ./test_ca.crt --key ./client.key --cert ./client.crt:<span class="built_in">test</span> -v</span><br></pre></td></tr></table></figure>
<h2 id="附录、参考文献"><a href="#附录、参考文献" class="headerlink" title="附录、参考文献"></a>附录、参考文献</h2><ul>
<li><a href="http://nginx.org/en/docs/http/ngx_http_ssl_module.html" target="_blank" rel="noopener">ngx_http_ssl_module</a></li>
<li><a href="https://blog.freessl.cn/ssl-cert-format-introduce/" target="_blank" rel="noopener">SSL 证书格式普及</a></li>
<li><a href="https://www.cnblogs.com/iiiiher/p/8085698.html" target="_blank" rel="noopener">证书各个字段的含义</a></li>
</ul>

        </div>

        
            <section class="post-copyright">
                
                    <p class="copyright-item">
                        <span>Author:</span>
                        <span>Arthur Lu</span>
                    </p>
                
                
                    <p class="copyright-item">
                        <span>Permalink:</span>
                        <span><a href="http://github.com/lsj9383/2020/03/30/Nginx-SSL证书配置/">http://github.com/lsj9383/2020/03/30/Nginx-SSL证书配置/</a></span>
                    </p>
                
                <!-- 
                    <p class="copyright-item">
                        <span>License:</span>
                        <span>Copyright (c) 2019 <a href="http://creativecommons.org/licenses/by-nc/4.0/">CC-BY-NC-4.0</a> LICENSE</span>
                    </p>
                 -->
                <!-- 
                     <p class="copyright-item">
                         <span>Slogan:</span>
                         <span>Do you believe in <strong>DESTINY<strong>?</span>
                     </p>
                 -->

            </section>
        
        <!-- <section class="post-tags">
            <div>
                <span>Tag(s):</span>
                <span class="tag">
                    
                </span>
            </div>
            <div>
                <a href="javascript:window.history.back();">back</a>
                <span>· </span>
                <a href="/">home</a>
            </div>
        </section> -->
        <section class="post-nav">
            
            
            <a class="next" rel="next" href="/2020/03/29/Tableau-Server-OIDC-AuthN/">Tableau Server OIDC AuthN</a>
            
        </section>


    </article>
</div>

        </div>
        <footer id="footer" class="footer">
    <div class="copyright">
        <span>© Arthur Lu | Powered by <a href="https://hexo.io" target="_blank">Hexo</a></span>
    </div>
</footer>

    </div><!-- hexo-inject:begin --><!-- hexo-inject:end -->
</body>
</html>
